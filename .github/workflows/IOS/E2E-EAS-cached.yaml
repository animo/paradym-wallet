name: iOS E2E via EAS cached

on:
  workflow_dispatch:

jobs:
  ios-e2e:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js (match EAS base config)
        uses: actions/setup-node@v4
        with:
          node-version: 20.11.1

      - name: Enable corepack (pnpm)
        run: corepack enable

      - name: Setup pnpm cache
        uses: actions/setup-node@v4
        with:
          node-version: 20.11.1
          cache: pnpm
          cache-dependency-path: |
            pnpm-lock.yaml
            **/pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install

      - name: Restore cached iOS simulator app
        id: ios-app-cache
        uses: actions/cache@v4
        with:
          path: apps/easypid/dist/ios-simulator-app.tar.gz
          key: >
            ios-sim-app-${{ runner.os }}-
            ${{ hashFiles(
              'pnpm-lock.yaml',
              'apps/easypid/ios/Podfile.lock',
              'apps/easypid/app.config.*',
              'apps/easypid/app.json',
              'apps/easypid/**/*.{ts,tsx,js,jsx}'
            ) }}

      - name: Build iOS simulator app with EAS local
        if: steps.ios-app-cache.outputs.cache-hit != 'true'
        working-directory: apps/easypid
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          set -euo pipefail

          pnpm dlx eas-cli@latest build \
            --local \
            --non-interactive \
            --platform ios \
            --profile paradym-preview-simulator

          echo "Looking for EAS local build archive (build-*.tar.gz) in current directory"

          BUILD_ARCHIVE=$(find . -maxdepth 2 -type f -name "build-*.tar.gz" | sort | tail -n 1)

          if [ -z "$BUILD_ARCHIVE" ]; then
            echo "No local EAS build archive (build-*.tar.gz) found"
            ls -R
            exit 1
          fi

          echo "Found build archive: $BUILD_ARCHIVE"

          mkdir -p dist
          mv "$BUILD_ARCHIVE" dist/ios-simulator-app.tar.gz

      - name: Extract .app from EAS build (cached or newly built)
        working-directory: apps/easypid
        run: |
          set -euo pipefail

          ARCHIVE="dist/ios-simulator-app.tar.gz"

          if [ ! -f "$ARCHIVE" ]; then
            echo "Archive $ARCHIVE not found"
            ls -R
            exit 1
          fi

          rm -rf dist/extracted
          mkdir -p dist/extracted

          tar -xzf "$ARCHIVE" -C dist/extracted

          APP_REL_PATH=$(find dist/extracted -maxdepth 6 -name "*.app" -type d | head -n 1)

          if [ -z "$APP_REL_PATH" ]; then
            echo "No .app found inside extracted archive"
            ls -R dist/extracted || true
            exit 1
          fi

          APP_PATH="$PWD/$APP_REL_PATH"
          echo "Found .app at: $APP_PATH"

          echo "APP_PATH=$APP_PATH" >> "$GITHUB_ENV"

      - name: Launch iOS simulator
        uses: futureware-tech/simulator-action@v4
        with:
          model: 'iPhone 16'

      - name: Install app on simulator
        run: |
          set -euo pipefail

          if [ -z "${APP_PATH:-}" ]; then
            echo "APP_PATH is empty or not set"
            exit 1
          fi

          echo "Using APP_PATH: $APP_PATH"

          DEVICE_UDID=$(xcrun simctl list devices | awk -F '[()]' '/iPhone 16/ && /Booted/ {print $2; exit}')

          if [ -z "$DEVICE_UDID" ]; then
            echo "No booted iPhone 16 simulator found."
            xcrun simctl list devices
            exit 1
          fi

          echo "Installing app on simulator $DEVICE_UDID"
          xcrun simctl install "$DEVICE_UDID" "$APP_PATH"
